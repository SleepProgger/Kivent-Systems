

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>kivent_maps.map_utils &mdash; KivEnt 2.2.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="KivEnt 2.2.0 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> KivEnt
          

          
          </a>

          
            
            
              <div class="version">
                2.2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../gameworld.html">GameWorld</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../entity.html">Entity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gamesystems.html">Game Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../managers.html">Managers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../physics.html">The Cymunk Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../particles.html">Particles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rendering.html">Rendering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../memory_handlers.html">Memory Handlers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tiled.html">The Maps Module</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">KivEnt</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>kivent_maps.map_utils</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for kivent_maps.map_utils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">tmx</span>
<span class="kn">from</span> <span class="nn">tmx</span> <span class="kn">import</span> <span class="n">Layer</span><span class="p">,</span> <span class="n">ObjectGroup</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">basename</span><span class="p">,</span> <span class="n">dirname</span>

<span class="kn">from</span> <span class="nn">kivent_core.systems.renderers</span> <span class="kn">import</span> <span class="n">Renderer</span><span class="p">,</span> <span class="n">ColorPolyRenderer</span>
<span class="kn">from</span> <span class="nn">kivent_core.systems.animation</span> <span class="kn">import</span> <span class="n">AnimationSystem</span>

<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">radians</span>

<div class="viewcode-block" id="load_map_systems"><a class="viewcode-back" href="../../tiled.html#kivent_maps.map_utils.load_map_systems">[docs]</a><span class="k">def</span> <span class="nf">load_map_systems</span><span class="p">(</span><span class="n">layer_count</span><span class="p">,</span> <span class="n">gameworld</span><span class="p">,</span> <span class="n">renderargs</span><span class="p">,</span> <span class="n">animargs</span><span class="p">,</span> <span class="n">polyargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create and initialise the systems required for displaying all layers of the</span>
<span class="sd">    map. Each layer requires a Renderer for images, PolyRenderer for shapes</span>
<span class="sd">    and AnimationSystem for animated tiles.</span>

<span class="sd">    The name format of the Renderer is map_layer%d, PolyRenderer is</span>
<span class="sd">    map_layer%d_polygons, AnimationSystem is map_layer%d_animator</span>
<span class="sd">    where %d is the layer number.</span>

<span class="sd">    Args:</span>
<span class="sd">        layer_count (unsigned int): Number of layers to init</span>

<span class="sd">        gameworld (Gameworld): Instance of the gameworld</span>

<span class="sd">        renderargs (dict): Dict of arguments required to init the Renderer.</span>
<span class="sd">        This is same as those used in a KV file for adding a system.</span>

<span class="sd">        animargs (dict): Dict of arguments required to init the AnimationSystem</span>

<span class="sd">        polyargs (dict): Dict of arguments required to init the PolyRenderer.</span>

<span class="sd">    Return:</span>
<span class="sd">        list of str, list of str: A tuple of two lists of system names with fisrt</span>
<span class="sd">        containing names of Renderers and PolyRenderers and second containing</span>
<span class="sd">        names of AnimationSystems. The names are in the order in which they are</span>
<span class="sd">        added to the Gameworld. You can use these lists for init_gameworld</span>
<span class="sd">        and setup_state.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">rendersystems</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">layer_count</span><span class="p">):</span>
        <span class="n">rendersystems</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;map_layer</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;map_layer</span><span class="si">%d</span><span class="s1">_polygons&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">])</span>
    <span class="n">animsystems</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;map_layer</span><span class="si">%d</span><span class="s1">_animator&#39;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">layer_count</span><span class="p">)]</span>

    <span class="n">system_count</span> <span class="o">=</span> <span class="n">gameworld</span><span class="o">.</span><span class="n">system_count</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">layer_count</span><span class="p">):</span>
        <span class="n">renderargs</span><span class="p">[</span><span class="s1">&#39;system_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rendersystems</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">renderargs</span><span class="p">[</span><span class="s1">&#39;system_names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">rendersystems</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">],</span> <span class="s1">&#39;position&#39;</span><span class="p">]</span>
        <span class="n">animargs</span><span class="p">[</span><span class="s1">&#39;system_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">animsystems</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">animargs</span><span class="p">[</span><span class="s1">&#39;system_names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">animsystems</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">rendersystems</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]]</span>
        <span class="n">polyargs</span><span class="p">[</span><span class="s1">&#39;system_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rendersystems</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">polyargs</span><span class="p">[</span><span class="s1">&#39;system_names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">rendersystems</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                                    <span class="s1">&#39;position&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;color&#39;</span><span class="p">]</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">Renderer</span><span class="p">()</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">AnimationSystem</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">ColorPolyRenderer</span><span class="p">()</span>

        <span class="n">r</span><span class="o">.</span><span class="n">gameworld</span> <span class="o">=</span> <span class="n">gameworld</span>
        <span class="n">a</span><span class="o">.</span><span class="n">gameworld</span> <span class="o">=</span> <span class="n">gameworld</span>
        <span class="n">p</span><span class="o">.</span><span class="n">gameworld</span> <span class="o">=</span> <span class="n">gameworld</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">renderargs</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">renderargs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">animargs</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">animargs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">polyargs</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">polyargs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="n">gameworld</span><span class="o">.</span><span class="n">add_widget</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">system_count</span><span class="p">)</span>
        <span class="n">gameworld</span><span class="o">.</span><span class="n">add_widget</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">system_count</span><span class="p">)</span>
        <span class="n">gameworld</span><span class="o">.</span><span class="n">add_widget</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">system_count</span><span class="p">)</span>
        <span class="n">system_count</span> <span class="o">+=</span> <span class="mi">3</span>

    <span class="n">gameworld</span><span class="o">.</span><span class="n">system_count</span> <span class="o">=</span> <span class="n">system_count</span>

    <span class="k">return</span> <span class="n">rendersystems</span><span class="p">,</span> <span class="n">animsystems</span></div>


<div class="viewcode-block" id="init_entities_from_map"><a class="viewcode-back" href="../../tiled.html#kivent_maps.map_utils.init_entities_from_map">[docs]</a><span class="k">def</span> <span class="nf">init_entities_from_map</span><span class="p">(</span><span class="n">tile_map</span><span class="p">,</span> <span class="n">init_entity</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Initialise entities for every layer of every tile and add them to the</span>
<span class="sd">    corresponding systems.</span>

<span class="sd">    Args:</span>
<span class="sd">        tile_map (TileMap): the tile map from which to load the tiles.</span>

<span class="sd">        init_entity (function): the gameworld.init_entity function</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">z_map</span> <span class="o">=</span> <span class="n">tile_map</span><span class="o">.</span><span class="n">z_index_map</span>

    <span class="c1"># Load tile entities</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tile_map</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tile_map</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="c1"># Get Tile object for position (i, j)</span>
            <span class="n">tile_layers</span> <span class="o">=</span> <span class="n">tile_map</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>

            <span class="c1"># Loop through all LayerTiles</span>
            <span class="k">for</span> <span class="n">tile</span> <span class="ow">in</span> <span class="n">tile_layers</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
                <span class="n">renderer_name</span> <span class="o">=</span> <span class="s1">&#39;map_layer</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">z_map</span><span class="p">[</span><span class="n">tile</span><span class="o">.</span><span class="n">layer</span><span class="p">]</span>
                <span class="n">animator_name</span> <span class="o">=</span> <span class="s1">&#39;map_layer</span><span class="si">%d</span><span class="s1">_animator&#39;</span> <span class="o">%</span> <span class="n">z_map</span><span class="p">[</span><span class="n">tile</span><span class="o">.</span><span class="n">layer</span><span class="p">]</span>
                <span class="n">comp_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">tile_map</span><span class="o">.</span><span class="n">get_tile_position</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span>
                    <span class="s1">&#39;tile_map&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">tile_map</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)},</span>
                    <span class="n">renderer_name</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">tile</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                        <span class="s1">&#39;texture&#39;</span><span class="p">:</span> <span class="n">tile</span><span class="o">.</span><span class="n">texture</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="n">systems</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="s1">&#39;tile_map&#39;</span><span class="p">,</span> <span class="n">renderer_name</span><span class="p">]</span>

                <span class="c1"># If tile is animated add that component</span>
                <span class="k">if</span> <span class="n">tile</span><span class="o">.</span><span class="n">animation</span><span class="p">:</span>
                    <span class="n">comp_data</span><span class="p">[</span><span class="n">animator_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">tile</span><span class="o">.</span><span class="n">animation</span><span class="p">,</span>
                        <span class="s1">&#39;loop&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                            <span class="p">}</span>
                    <span class="n">systems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">animator_name</span><span class="p">)</span>

                <span class="n">init_entity</span><span class="p">(</span><span class="n">comp_data</span><span class="p">,</span> <span class="n">systems</span><span class="p">)</span>

    <span class="c1"># Load object entities</span>
    <span class="k">for</span> <span class="n">obj_layer</span> <span class="ow">in</span> <span class="n">tile_map</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
        <span class="n">mh</span> <span class="o">=</span> <span class="n">tile_map</span><span class="o">.</span><span class="n">size_on_screen</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">obj_layer</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">texture</span><span class="p">:</span>
                <span class="c1"># Object is an image</span>
                <span class="n">renderer_name</span> <span class="o">=</span> <span class="s1">&#39;map_layer</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">z_map</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">layer</span><span class="p">]</span>
                <span class="n">comp_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mh</span> <span class="o">-</span> <span class="n">obj</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="n">renderer_name</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                        <span class="s1">&#39;texture&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">texture</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="n">systems</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="n">renderer_name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Object is a shape</span>
                <span class="n">renderer_name</span> <span class="o">=</span> <span class="s1">&#39;map_layer</span><span class="si">%d</span><span class="s1">_polygons&#39;</span> <span class="o">%</span> <span class="n">z_map</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">layer</span><span class="p">]</span>
                <span class="n">comp_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mh</span> <span class="o">-</span> <span class="n">obj</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="n">renderer_name</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;model_key&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="c1"># Color is taken from vertex, so white here</span>
                    <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="n">systems</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">,</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">renderer_name</span><span class="p">]</span>

            <span class="n">init_entity</span><span class="p">(</span><span class="n">comp_data</span><span class="p">,</span> <span class="n">systems</span><span class="p">)</span></div>

<div class="viewcode-block" id="parse_tmx"><a class="viewcode-back" href="../../tiled.html#kivent_maps.map_utils.parse_tmx">[docs]</a><span class="k">def</span> <span class="nf">parse_tmx</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">gameworld</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Uses the tmx library to load the TMX into an object and then calls all the</span>
<span class="sd">    util functions with the relevant data.</span>

<span class="sd">    Args:</span>
<span class="sd">        filename (str): Name of the tmx file.</span>

<span class="sd">        gameworld (Gameworld): instance of the gameworld.</span>

<span class="sd">    Return:</span>
<span class="sd">        str: name of the loaded map which is the filename</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">texture_manager</span> <span class="o">=</span> <span class="n">gameworld</span><span class="o">.</span><span class="n">managers</span><span class="p">[</span><span class="s1">&#39;texture_manager&#39;</span><span class="p">]</span>
    <span class="n">model_manager</span> <span class="o">=</span> <span class="n">gameworld</span><span class="o">.</span><span class="n">managers</span><span class="p">[</span><span class="s1">&#39;model_manager&#39;</span><span class="p">]</span>
    <span class="n">map_manager</span> <span class="o">=</span> <span class="n">gameworld</span><span class="o">.</span><span class="n">managers</span><span class="p">[</span><span class="s1">&#39;map_manager&#39;</span><span class="p">]</span>
    <span class="n">animation_manager</span> <span class="o">=</span> <span class="n">gameworld</span><span class="o">.</span><span class="n">managers</span><span class="p">[</span><span class="s1">&#39;animation_manager&#39;</span><span class="p">]</span>

    <span class="c1"># Get tilemap object with all the data from tmx</span>
    <span class="n">tilemap</span> <span class="o">=</span> <span class="n">tmx</span><span class="o">.</span><span class="n">TileMap</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1"># Get the tiles as a 3D list and the z_map, objects as a 2D list and the</span>
    <span class="c1"># z_map, the set of tile_ids which will be used in the map,</span>
    <span class="c1"># set of models of the objects in the map.</span>
    <span class="n">tiles</span><span class="p">,</span> <span class="n">tiles_z</span><span class="p">,</span> <span class="n">objects</span><span class="p">,</span> <span class="n">objects_z</span><span class="p">,</span> <span class="n">tile_ids</span><span class="p">,</span> <span class="n">objmodels</span> <span class="o">=</span> \
            <span class="n">_load_tile_map</span><span class="p">(</span><span class="n">tilemap</span><span class="o">.</span><span class="n">layers</span><span class="p">,</span> <span class="n">tilemap</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                           <span class="n">_load_tile_properties</span><span class="p">(</span><span class="n">tilemap</span><span class="o">.</span><span class="n">tilesets</span><span class="p">))</span>

    <span class="c1"># Loads the models, textures and animations of the tileset into</span>
    <span class="c1"># corresponding managers</span>
    <span class="n">_load_tilesets</span><span class="p">(</span><span class="n">tilemap</span><span class="o">.</span><span class="n">tilesets</span><span class="p">,</span> <span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">tile_ids</span><span class="p">,</span>
                   <span class="n">texture_manager</span><span class="o">.</span><span class="n">load_atlas</span><span class="p">,</span>
                   <span class="n">model_manager</span><span class="o">.</span><span class="n">load_textured_rectangle</span><span class="p">,</span>
                   <span class="n">animation_manager</span><span class="o">.</span><span class="n">load_animation</span><span class="p">)</span>

    <span class="c1"># Load the object models with model_manager</span>
    <span class="n">_load_obj_models</span><span class="p">(</span><span class="n">objmodels</span><span class="p">,</span> <span class="n">model_manager</span><span class="o">.</span><span class="n">load_textured_rectangle</span><span class="p">,</span>
                     <span class="n">model_manager</span><span class="o">.</span><span class="n">load_model</span><span class="p">)</span>

    <span class="c1"># Load the map with map_manager</span>
    <span class="n">name</span> <span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">map_manager</span><span class="o">.</span><span class="n">load_map</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tilemap</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">tilemap</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
                         <span class="n">tiles</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tiles_z</span><span class="p">),</span>
                         <span class="n">objects</span><span class="p">,</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">]),</span>
                         <span class="n">tilemap</span><span class="o">.</span><span class="n">orientation</span><span class="p">)</span>

    <span class="c1"># Set the extra map properties for hexagonal/staggered maps</span>
    <span class="n">loaded_map</span> <span class="o">=</span> <span class="n">map_manager</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="n">loaded_map</span><span class="o">.</span><span class="n">tile_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">tilemap</span><span class="o">.</span><span class="n">tilewidth</span><span class="p">,</span> <span class="n">tilemap</span><span class="o">.</span><span class="n">tileheight</span><span class="p">)</span>
    <span class="n">loaded_map</span><span class="o">.</span><span class="n">z_index_map</span> <span class="o">=</span> <span class="n">tiles_z</span> <span class="o">+</span> <span class="n">objects_z</span>
    <span class="k">if</span> <span class="n">tilemap</span><span class="o">.</span><span class="n">staggerindex</span><span class="p">:</span>
        <span class="n">loaded_map</span><span class="o">.</span><span class="n">stagger_index</span> <span class="o">=</span> <span class="n">tilemap</span><span class="o">.</span><span class="n">staggerindex</span>
    <span class="k">if</span> <span class="n">tilemap</span><span class="o">.</span><span class="n">staggeraxis</span><span class="p">:</span>
        <span class="n">loaded_map</span><span class="o">.</span><span class="n">stagger_axis</span> <span class="o">=</span> <span class="n">tilemap</span><span class="o">.</span><span class="n">staggeraxis</span>
    <span class="k">if</span> <span class="n">tilemap</span><span class="o">.</span><span class="n">hexsidelength</span><span class="p">:</span>
        <span class="n">loaded_map</span><span class="o">.</span><span class="n">hex_side_length</span> <span class="o">=</span> <span class="n">tilemap</span><span class="o">.</span><span class="n">hexsidelength</span>

    <span class="k">return</span> <span class="n">name</span></div>


<span class="k">def</span> <span class="nf">_load_tilesets</span><span class="p">(</span><span class="n">tilesets</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">tile_ids</span><span class="p">,</span>
                   <span class="n">load_atlas</span><span class="p">,</span> <span class="n">load_model</span><span class="p">,</span> <span class="n">load_animation</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Tileset of the map contains an atlas of the images used by the tiles. We</span>
<span class="sd">    need to load all those images as textures and models. If they are animated</span>
<span class="sd">    tiles we also load an animation for them.</span>

<span class="sd">    The texture, model names are in the format tile_%d where %d is the tile&#39;s</span>
<span class="sd">    gid. For animation the format is animation_tile_%d.</span>

<span class="sd">    Args:</span>
<span class="sd">        tilesets (list): List of TileSet objects. We can create an atlas of</span>
<span class="sd">        the tile images from TileSet data using the tile_ids.</span>

<span class="sd">        dirname (str): Directory of the image source of the tilesets</span>

<span class="sd">        tile_ids (list): List of tile ids which need to be loaded from the</span>
<span class="sd">        tileset.</span>

<span class="sd">        load_atlas (function): Takes an atlas dict and loads textures in the</span>
<span class="sd">        texture_manager</span>

<span class="sd">        load_model (function): Loads models for all loaded textures in the</span>
<span class="sd">        model_manager.</span>

<span class="sd">        load_animation (function): Takes frames of an animated tile and loads</span>
<span class="sd">        an animation.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">atlas_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">model_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">animation_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">tileset</span> <span class="ow">in</span> <span class="n">tilesets</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">tileset</span><span class="o">.</span><span class="n">image</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">source</span>
        <span class="n">fgid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tileset</span><span class="o">.</span><span class="n">firstgid</span><span class="p">)</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">width</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
        <span class="n">tw</span><span class="p">,</span> <span class="n">th</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tileset</span><span class="o">.</span><span class="n">tilewidth</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">tileset</span><span class="o">.</span><span class="n">tileheight</span><span class="p">)</span>
        <span class="n">m</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tileset</span><span class="o">.</span><span class="n">margin</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">tileset</span><span class="o">.</span><span class="n">spacing</span><span class="p">)</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span><span class="o">//</span><span class="p">(</span><span class="n">tw</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">m</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span><span class="o">//</span><span class="p">(</span><span class="n">th</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">m</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">tile</span> <span class="ow">in</span> <span class="n">tileset</span><span class="o">.</span><span class="n">tiles</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tile</span><span class="o">.</span><span class="n">animation</span><span class="p">:</span>
                <span class="n">animation</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">tile</span><span class="o">.</span><span class="n">animation</span><span class="p">:</span>
                    <span class="n">animation</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;texture&#39;</span><span class="p">:</span> <span class="s1">&#39;tile_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">tileid</span> <span class="o">+</span> <span class="n">fgid</span><span class="p">),</span>
                        <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="s1">&#39;tile_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">tileid</span> <span class="o">+</span> <span class="n">fgid</span><span class="p">),</span>
                        <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="n">frame</span><span class="o">.</span><span class="n">duration</span>
                    <span class="p">})</span>
                    <span class="n">tile_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">tileid</span> <span class="o">+</span> <span class="n">fgid</span><span class="p">)</span>
                <span class="n">animation_name</span> <span class="o">=</span> <span class="s1">&#39;animation_tile_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tile</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="n">fgid</span><span class="p">)</span>
                <span class="n">animation_data</span><span class="p">[</span><span class="n">animation_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">animation</span>

        <span class="n">atlas_data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">tile</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rows</span><span class="o">*</span><span class="n">cols</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">tile</span> <span class="o">+</span> <span class="n">fgid</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tile_ids</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">tile</span> <span class="o">%</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">tile</span> <span class="o">/</span> <span class="n">rows</span><span class="p">)</span>
                <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">tw</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">m</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="n">y</span> <span class="o">*</span> <span class="p">(</span><span class="n">th</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">m</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="n">m</span>
                <span class="n">atlas_data</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;tile_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tile</span> <span class="o">+</span> <span class="n">fgid</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">tw</span><span class="p">,</span> <span class="n">th</span><span class="p">)</span>
                <span class="n">model_data</span><span class="p">[</span><span class="s1">&#39;tile_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tile</span> <span class="o">+</span> <span class="n">fgid</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tw</span><span class="p">,</span> <span class="n">th</span><span class="p">)</span>

    <span class="n">load_atlas</span><span class="p">(</span><span class="n">atlas_data</span><span class="p">,</span> <span class="s1">&#39;dict&#39;</span><span class="p">,</span> <span class="n">dirname</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">model_data</span><span class="p">:</span>
        <span class="n">tw</span><span class="p">,</span> <span class="n">th</span> <span class="o">=</span> <span class="n">model_data</span><span class="p">[</span><span class="n">model</span><span class="p">]</span>
        <span class="n">load_model</span><span class="p">(</span><span class="s1">&#39;vertex_format_4f&#39;</span><span class="p">,</span> <span class="n">tw</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">animation</span> <span class="ow">in</span> <span class="n">animation_data</span><span class="p">:</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="n">animation_data</span><span class="p">[</span><span class="n">animation</span><span class="p">]</span>
        <span class="n">load_animation</span><span class="p">(</span><span class="n">animation</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">),</span> <span class="n">frames</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_load_obj_models</span><span class="p">(</span><span class="n">objmodels</span><span class="p">,</span>
                     <span class="n">load_img_model</span><span class="p">,</span> <span class="n">load_poly_model</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Object models are a list of vertices for a shape or a model for a texture.</span>
<span class="sd">    They are read from the map and loaded into model_manager here.</span>

<span class="sd">    Args:</span>
<span class="sd">        objmodels (list): List of dicts containing model data.</span>

<span class="sd">        load_img_model (function): Load model for an image texture.</span>

<span class="sd">        load_poly_model (function): Load model from a set of vertices.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">objname</span> <span class="ow">in</span> <span class="n">objmodels</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">objmodels</span><span class="p">[</span><span class="n">objname</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;texture&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
            <span class="n">load_img_model</span><span class="p">(</span><span class="s1">&#39;vertex_format_4f&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">],</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span>
                    <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;texture&#39;</span><span class="p">],</span> <span class="n">objname</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;vertices&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
            <span class="n">load_poly_model</span><span class="p">(</span><span class="s1">&#39;vertex_format_2f4ub&#39;</span><span class="p">,</span>
                            <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;vertex_count&#39;</span><span class="p">],</span>
                            <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;index_count&#39;</span><span class="p">],</span>
                            <span class="n">objname</span><span class="p">,</span>
                            <span class="n">vertices</span><span class="o">=</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;vertices&#39;</span><span class="p">],</span>
                            <span class="n">indices</span><span class="o">=</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_load_tile_map</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">tile_properties</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Loads data for all the tiles and objects of the tilemap as dicts</span>
<span class="sd">    which will directly be passed to map_manager. While looping through all</span>
<span class="sd">    tiles and objects it creates the z_index map, stores a unique set of</span>
<span class="sd">    tile_ids which will be used so we only load that data and also dicts for</span>
<span class="sd">    object models.</span>

<span class="sd">    The dicts for object models require generating the vertices of the polygons</span>
<span class="sd">    and hence has different math for different types of shapes.</span>

<span class="sd">    Args:</span>
<span class="sd">        layers (unsigned int): Number of layers to load</span>

<span class="sd">        width (unsigned int): Number of columns.</span>

<span class="sd">        tile_properties (dict): A map for specific tile properties to be loaded.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tiles</span><span class="p">)</span><span class="o">/</span><span class="n">width</span><span class="p">)</span>
    <span class="n">tiles</span> <span class="o">=</span> <span class="p">[[[]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width</span><span class="p">)]</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tiles</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">tiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">objmodels</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">tile_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="n">tile_layer_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tile_zindex</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">obj_layer_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">obj_zindex</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layers</span><span class="p">):</span>
        <span class="n">layerobjs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="o">==</span> <span class="n">Layer</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">tile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">tiles</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">tile</span><span class="o">.</span><span class="n">gid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">tile_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tile</span><span class="o">.</span><span class="n">gid</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">tile</span><span class="o">.</span><span class="n">gid</span> <span class="ow">in</span> <span class="n">tile_properties</span><span class="p">:</span>
                        <span class="n">tile</span> <span class="o">=</span> <span class="n">tile_properties</span><span class="p">[</span><span class="n">tile</span><span class="o">.</span><span class="n">gid</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tile</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;texture&#39;</span><span class="p">:</span> <span class="s1">&#39;tile_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">tile</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="s1">&#39;tile_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">tile</span><span class="o">.</span><span class="n">gid</span><span class="p">}</span>
                    <span class="n">tile</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile_layer_count</span>

                    <span class="n">tiles</span><span class="p">[</span><span class="n">n</span><span class="o">%</span><span class="n">width</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="n">width</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span>
            <span class="n">tile_layer_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tile_zindex</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="o">==</span> <span class="n">ObjectGroup</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">color</span>
                <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">red</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">green</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">blue</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">objects</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">gid</span><span class="p">:</span>
                    <span class="n">tile_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">gid</span><span class="p">)</span>
                    <span class="n">gid</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">height</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;texture&#39;</span><span class="p">:</span> <span class="s1">&#39;tile_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">gid</span><span class="p">,</span>
                           <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="s1">&#39;obj_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj_layer_count</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span>
                           <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">)}</span>
                    <span class="n">objmodel</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;texture&#39;</span><span class="p">:</span> <span class="s1">&#39;tile_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">gid</span><span class="p">,</span>
                                <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">width</span><span class="p">,</span>
                                <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height</span><span class="p">}</span>
                <span class="k">elif</span> <span class="n">obj</span><span class="o">.</span><span class="n">polygon</span><span class="p">:</span>
                    <span class="n">x_coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">polygon</span><span class="p">]</span>
                    <span class="n">y_coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">polygon</span><span class="p">]</span>

                    <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">x_coords</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">x_coords</span><span class="p">),</span>
                            <span class="nb">max</span><span class="p">(</span><span class="n">y_coords</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_coords</span><span class="p">))</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span>

                    <span class="n">vertices</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">polygon</span><span class="p">):</span>
                        <span class="n">vertices</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                       <span class="s1">&#39;v_color&#39;</span><span class="p">:</span> <span class="n">color</span><span class="p">}</span>
                        <span class="k">if</span> <span class="n">n</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">n</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">polygon</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">indices</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="s1">&#39;obj_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj_layer_count</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span>
                           <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">}</span>
                    <span class="n">objmodel</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;vertices&#39;</span><span class="p">:</span> <span class="n">vertices</span><span class="p">,</span>
                                <span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="n">indices</span><span class="p">,</span>
                                <span class="s1">&#39;vertex_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">vertices</span><span class="p">),</span>
                                <span class="s1">&#39;index_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)}</span>
                <span class="k">elif</span> <span class="n">obj</span><span class="o">.</span><span class="n">ellipse</span><span class="p">:</span>
                    <span class="n">vertices</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">width</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">height</span><span class="o">/</span><span class="mf">2.</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">360</span><span class="p">):</span>
                        <span class="n">ang</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">ang</span><span class="p">),</span> <span class="n">b</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span>
                        <span class="n">vertices</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="n">v</span><span class="p">,</span>
                                       <span class="s1">&#39;v_color&#39;</span><span class="p">:</span> <span class="n">color</span><span class="p">}</span>
                        <span class="k">if</span> <span class="n">t</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">t</span><span class="o">&lt;</span><span class="mi">359</span><span class="p">:</span>
                            <span class="n">indices</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="s1">&#39;obj_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj_layer_count</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span>
                           <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                                        <span class="n">obj</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
                          <span class="p">}</span>
                    <span class="n">objmodel</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;vertices&#39;</span><span class="p">:</span> <span class="n">vertices</span><span class="p">,</span>
                                <span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="n">indices</span><span class="p">,</span>
                                <span class="s1">&#39;vertex_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">vertices</span><span class="p">),</span>
                                <span class="s1">&#39;index_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">height</span>
                    <span class="n">objmodel</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;vertices&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="mi">0</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="n">w</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mf">2.</span><span class="p">),</span>
                                              <span class="s1">&#39;v_color&#39;</span><span class="p">:</span> <span class="n">color</span><span class="p">},</span>
                                          <span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="n">w</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mf">2.</span><span class="p">),</span>
                                              <span class="s1">&#39;v_color&#39;</span><span class="p">:</span> <span class="n">color</span><span class="p">},</span>
                                          <span class="mi">2</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">w</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mf">2.</span><span class="p">),</span>
                                              <span class="s1">&#39;v_color&#39;</span><span class="p">:</span> <span class="n">color</span><span class="p">},</span>
                                          <span class="mi">3</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">w</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mf">2.</span><span class="p">),</span>
                                              <span class="s1">&#39;v_color&#39;</span><span class="p">:</span> <span class="n">color</span><span class="p">}},</span>
                            <span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                            <span class="s1">&#39;vertex_count&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                            <span class="s1">&#39;index_count&#39;</span><span class="p">:</span> <span class="mi">6</span>
                            <span class="p">}</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="s1">&#39;obj_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj_layer_count</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span>
                           <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                                        <span class="n">obj</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">)}</span>

                <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;obj_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj_layer_count</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
                <span class="n">objmodels</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">objmodel</span>
                <span class="n">layerobjs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

            <span class="n">objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layerobjs</span><span class="p">)</span>
            <span class="n">obj_layer_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">obj_zindex</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tiles</span><span class="p">,</span> <span class="n">tile_zindex</span><span class="p">,</span> <span class="n">objects</span><span class="p">,</span> <span class="n">obj_zindex</span><span class="p">,</span> <span class="n">tile_ids</span><span class="p">,</span> <span class="n">objmodels</span>

<span class="k">def</span> <span class="nf">_load_tile_properties</span><span class="p">(</span><span class="n">tilesets</span><span class="p">):</span>
    <span class="n">tile_properties</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">tileset</span> <span class="ow">in</span> <span class="n">tilesets</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">tile</span> <span class="ow">in</span> <span class="n">tileset</span><span class="o">.</span><span class="n">tiles</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tile</span><span class="o">.</span><span class="n">animation</span><span class="p">:</span>
                <span class="n">gid</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="n">tileset</span><span class="o">.</span><span class="n">firstgid</span>
                <span class="n">tile_properties</span><span class="p">[</span><span class="n">gid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;animation&#39;</span><span class="p">:</span>
                            <span class="s1">&#39;animation_tile_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">gid</span>
                    <span class="p">}</span>

    <span class="k">return</span> <span class="n">tile_properties</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014-2017, Jacob Kovac.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'2.2.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>